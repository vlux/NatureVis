<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="description" content="Spiral (L-system)" />
    <title>L-system</title>
    <script src="d3/d3.js"></script>
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
  <script>

  //compute a Lindenmayer system given an axiom, a number of steps and rules
  (function() {

      var curve, d, fractalize, height, svg, svg_path, transition, tweenDash,width;

      var piex = [],piey = [];

      var days = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

      fractalize = function(config) {
          var char, i, input, output, _i, _j, _len, _ref;
          input = config.axiom;
          for (i = _i = 0, _ref = config.steps; 0 <= _ref ? _i < _ref :_i > _ref; i = 0 <= _ref ? ++_i : --_i) {
              output = '';
              for (_j = 0, _len = input.length ; _j < _len; _j++) {
                  char = input[_j];
                  if (char in config.rules)
                      output += config.rules[char];
                  else
                      output += char;
              }
              input = output;
          }
          return output;
      };

      // convert a Lindenmayer string into an SVG path string
      svg_path = function(config) {
          var angle, char, path, _i, _len, _ref,idx;
          var xT,yT,nxT,nyT;
          var xcor= [],ycor = [],angles = [];
          idx = 1;
          angle = Math.PI / 2 * 3;
          path = 'M0 0';
          xT = 0,yT =0;
          _ref = config.fractal;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              char = _ref[_i];
              if (char === '+')
                  angle -= config.da;
              else if (char === '-')
                  angle += config.da;
              else if (char === 'F'){
                  nxT = xT + config.side * Math.cos(angle);
                  nyT = yT + config.side * Math.sin(angle);
                  path += "L" + nxT + " " + nyT;
                  xT = nxT;
                  yT = nyT;
              }
              else if (char === '['){
                  xcor[idx] = xT;
                  ycor[idx] = yT;
                  angles[idx++] = angle;
              }
              else if (char === ']'){
                  xT = xcor[--idx];
                  yT = ycor[idx ];
                  angle = angles[idx];
                  path += "M" + xT + " " + yT;
              }
              else if (char === 'E'){
                  piex.push(xT);
                  piey.push(yT);
              }
          }
          return path;
      };

      // animate the path
      // from Mike Bostock's stroke dash interpolation example http://bl.ocks.org/mbostock/5649592
      tweenDash = function() {
          var i, l;
          l = this.getTotalLength();
          i = d3.interpolateString('0,' + l, l + ',' + l);
          return function(t) {
              return i(t);
          };
      };
      transition = function(path) {
          return path.transition()
                .duration(20000)
                .attrTween('stroke-dasharray', tweenDash);
      };

      curve = fractalize({
          axiom:'FFFFFFFF[++FFFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF]FFFFFFFF[--FFFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF]FFFFFFFF[++FFFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF]FFFFFFFF[--FFFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF]FFFFFFFF[++FFFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF]FFFFFFFF[--FFFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF]FFFFFFFF[++FFFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF]FFFFFFFF[--FFFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF]FFFFFFFF[++FFFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF]FFFFFFFF[--FFFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF[--FFFE]FFF[++FFFE]FFF]FFFFFFFF',
          steps: 1,
          rules: {

          }
      });
      d = svg_path({
          fractal: curve,
          side: 7,      //length
          da:30 / 180 * Math.PI
      });

      width = 960;
      height = 760;

      svg = d3.select('body')
        	.append('svg')
            .attr('width', width)
            .attr('height', height)
            .append("g")
            .attr('transform', "translate(" + (width / 2) + "," + (height) +")");

      svg.append('path')
         .attr('class', 'curve shadow')
         .attr('d', d)

      svg.append('path')
        .attr('class', 'curve')
        .attr('d', d)
    //    .call(transition);

    var radius = Math.min(width, height) / 2,
        innerRadius = 0.2 * radius;

    var pie = d3.layout.pie()
            .sort(null)
            .value(function(d) { return d[1]; });

    var pie_api = d3.layout.pie()
            .sort(null)
            .value(function(d) { return d[1]; });

    var arc = d3.svg.arc()
                .innerRadius(innerRadius)
                .outerRadius(function (d) {
                  return (radius - innerRadius) * (d.value /150) + innerRadius;
                });
    var arc_api = d3.svg.arc()
                .innerRadius(innerRadius)
                .outerRadius(function (d) {
                      return (radius - innerRadius) * (d.value/150 ) + innerRadius;
                });

    var outlineArc = d3.svg.arc()
              .innerRadius(innerRadius)
              .outerRadius(radius);

    var tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([0, 0])
                .html(function(d) {
                    return d.data[0] + " : <span style='color:orangered'>" + d.data[1] + "</span>";
                });

    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    svg.call(tip);

    d3.csv('mean_month.csv', function(error, data){

        var NO2dataset = [],
            APIdataset = [];

        data.forEach(function(d) {
            if(d.key =="NO2")
                NO2dataset.push([d["key"], +d["2002"], +d["2003"], +d["2004"], +d["2005"], +d["2006"], +d["2007"], +d["2008"], +d["2009"], +d["2010"], +d["2011"]]);
            if(d.key =="API")
                APIdataset.push([d["key"], +d["2002"], +d["2003"], +d["2004"], +d["2005"], +d["2006"], +d["2007"], +d["2008"], +d["2009"], +d["2010"], +d["2011"]]);
        });

        svg.selectAll(".solidArc")
            .data(pie_api(APIdataset))
            .enter().append("path")
            .attr("fill", "orange")
            .attr("class", "solidArc")
            .attr("stroke", "silver")
            .attr("d", arc_api)
            .on('mouseover', tip.show)
            .on('mouseout', tip.hide);

        svg.selectAll(".solidArcs")
            .data(pie(NO2dataset))
            .enter().append("path")
            .attr("fill", "green")
            .attr("class", "solidArc")
            .attr("stroke", "silver")
            .attr("d", arc)
            .on('mouseover', tip.show)
            .on('mouseout', tip.hide);

        svg.selectAll(".outlineArc")
            .data(pie(APIdataset))
            .enter().append("path")
            .attr("fill", "none")
            .attr("stroke", "gray")
            .attr("opacity","0.15")
            .attr("class", "outlineArc")
            .attr("d", outlineArc);

        svg.append("text")
          .attr("class", "aster-score")
          .attr("dy", ".35em")
          .attr("text-anchor", "middle") // text-align: right
          .text("NO2");

    });

    //    svg.selectAll("circle")
    //       .data(piex)
    //       .enter()
    //       .append("circle")
    //       .attr("cx",function(d,i){
    //           return piex[i];
    //       })
    //       .attr("cy",function(d,i){
    //           return piey[i];
    //       })
    //       .attr("r",4)
    //       .style("fill","red");


  }).call(this);

</script>
</body>
</html>

<!-- matlab code -->
<!--
bemid = 'FFFFFFFF';
bran1 = 'FFF';
bran2 = 'FFF';
branc1 = [bran1 '[++' bran2 'E]' bran1 '[--' bran2 'E]'];
branc2 = [bran1 '[--' bran2 'E]' bran1 '[++' bran2 'E]'];
branch1 = ['F'];
branch2 = ['F'];
month = 12;
for i = 1: month / 2
    branch1 = [branch1 branc1];
    branch2 = [branch2 branc2];
end
branch1 = [branch1 bran2];
branch2 = [branch2 bran2];
axiom = [bemid '[++' branch1   ']' bemid '[--' branch2   ']' bemid '[++' branch1   ']' bemid '[--' branch2   ']'...
    bemid '[++' branch1   ']' bemid '[--' branch2   ']' bemid '[++' branch1   ']'...
    bemid '[--' branch2   ']' bemid '[++' branch1   ']' bemid '[--' branch2   ']' bemid]; -->
